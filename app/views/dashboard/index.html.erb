<div class="container">
  <!-- searching form -->
  <div class="">
    <br/>
    <%= form_tag('/dashboard/index', method: :get) do %>
      <div class="main-form panel">
        <div class="panel-heading">Program Inputs</div>
        <div class="panel-body">
          <div class="row">
            <div class="col-md-7">
              <div class="program-panel panel-basic">
                <div class="input-grp"><h5>Program Info</h5></div>
                <div class="row panel-body">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label>Bank Name</label>
                      <%= select_tag 'bank_name', options_for_select(@all_banks_name.sort_by!{ |m| m.downcase }, params[:bank_name]), { :class=> "form-control" ,:include_blank => 'All'} %>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label>Loan Category</label>
                      <%= select_tag 'loan_category', options_for_select(@loan_categories.sort_by!{ |m| m.downcase }, params[:loan_category]), { :class=> "form-control" ,:include_blank => 'All'} %>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label>Program Category</label>
                      <%= select_tag 'pro_category', options_for_select(@program_categories.flatten.sort_by!{ |m| m.downcase }, params[:pro_category]), { :class=> "form-control", :include_blank => 'All'} %>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label>Program Name</label>
                      <%= select_tag 'program_name', options_for_select(@program_names.sort_by!{ |m| m.downcase }, params[:program_name]), { :include_blank => 'All', :class=> "form-control"} %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-5">
              <div class="panel-basic">
                <div class="input-grp"><h5>Loan Property</h5></div>
                <div class="row panel-body">
                  <div class="col-md-5">
                    <div class="form-group">
                      <label>Loan Purpose</label>
                      <div class="input-group">
                        <%= select_tag 'loan_purpose', options_for_select(Program::LOAN_PURPOSE.flatten.sort_by!{ |m| m.downcase }, (params[:loan_purpose] rescue nil)), { prompt: 'Select Loan Purpose', :class=> "form-control",required: true }%>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-5">
                    <div class="form-group">
                      <label>Loan Size</label>
                      <div class="input-group">
                        <%= select_tag 'loan_size', options_for_select(Program::LOAN_SIZE.flatten.sort_by!{ |m| m.downcase }, (params[:loan_size] rescue nil)), { prompt: 'Select Loan Size', :class=> "form-control",required: true }%>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label>Loan Type</label>
                      <%= select_tag 'loan_type', options_for_select(Program::LOAN_TYPE.flatten.sort_by!{ |m| m.downcase }, (params[:loan_type] rescue nil)), { prompt: 'Select Loan Type', :class=> "form-control" ,required: true} %>
                    </div>
                  </div>
                  <div class="col-md-5 term">
                    <div class="form-group">
                      <label>Term</label>
                      <div class="input-group">
                        <%= select_tag 'term', options_for_select(@term_list, (params[:term] rescue nil)), { prompt: 'Select Term', :class=> "form-control"} %>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 arm-basic">
                    <div class="form-group">
                      <label>ARM Basic</label>
                      <div class="input-group">
                        <%= select_tag 'arm_basic', options_for_select(Program::ARN_BASIC.flatten.sort_by!{ |m| m.downcase }, (params[:arm_basic].present? ? params[:arm_basic] : "10/1 ARM")), { prompt: 'Select ARM Basic', :class=> "form-control"} %>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4 arm-basic">
                    <div class="form-group">
                      <label>ARM Advance</label>
                      <%= select_tag 'arm_advanced', options_for_select( @arm_advanced_list.flatten.sort_by!{ |m| m.downcase }, (params[:arm_advanced] rescue nil)), { prompt: 'Select ARM Advance', :class=> "form-control"} %>
                    </div>
                  </div>
                  <div class="col-md-5">
                    <div class="form-group">
                      <label>Interest Rate</label>
                       <% @interest_list =[["3.250"],["3.375"],["3.500"],["3.625"],["3.750"],["3.875"],["4.000"],["4.125"],["4.250"],["4.375"],["4.500"],["4.625"],["4.750"],["4.875"],["5.000"],["5.125"],["5.250"],["5.375"],["5.500"],["5.625"],["5.750"],["5.875"]]%>
                      <%= select_tag 'interest', options_for_select(@interest_list, @interest), :class=> "form-control" %>
                    </div>
                  </div>
                  <div class="col-md-5">
                    <div class="form-group">
                      <label>Lock Period</label>
                      <div class="input-group">
                        <% @lock_period_list =[["15 days","15"], ["30 days","30"], ["45 days","45"], ["60 days","60"], ["75 days","75"], ["90 days","90"]]%>
                        <%= select_tag 'lock_period', options_for_select(@lock_period_list, @lock_period), :class=> "form-control" %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-7">
              <div class="program-panel panel-basic">
                <div class="input-grp"><h5>FM</h5></div>
                <div class="row panel-body">
                  <div class="col-md-4">
                    <div class="form-group">
                      <div class="checkbox">
                        <label> <%= check_box_tag 'fannie_mae', 'fannie_mae', params[:fannie_mae].present? %> Fannie Mae</label>
                      </div>
                      <div class="checkbox">
                        <label> <%= check_box_tag 'freddie_mac', 'freddie_mac', params[:freddie_mac].present? %> Freddie Mac</label>
                      </div>
                      <div class="checkbox">
                        <label> <%= check_box_tag 'du', 'du', params[:du].present? %> DU</label>
                      </div>
                      <div class="checkbox">
                        <label> <%= check_box_tag 'lp', 'lp', params[:lp].present? %> LP</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label>Fannie Mae Product</label>
                      <%= select_tag 'fannie_mae_product', options_for_select(Program::FANNIE_MAE_PRODUCT_LIST.flatten.sort_by!{ |m| m.downcase }, (params[:fannie_mae_product] rescue nil)), { prompt: 'Select Fannie Mae Product', :class=> "form-control" } %>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label>Freddie Mac Product</label>
                      <%= select_tag 'freddie_mac_product', options_for_select(Program::FREDDIE_MAC_PRODUCT_LIST.flatten.sort_by!{ |m| m.downcase }, (params[:freddie_mac_product] rescue nil)), { prompt: 'Select Freddie Mac Product', :class=> "form-control" } %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="program-panel panel-basic">
                <div class="input-grp"><h5>Government Program</h5></div>
                <div class="row panel-body">
                  <div class="col-md-12">
                    <div class="form-group">
                      <div class="checkbox">
                        <label> <%= check_box_tag 'fha', 'fha', params[:fha].present? %> FHA</label>
                      </div>
                      <div class="checkbox">
                        <label><%= check_box_tag 'va', 'va', params[:va].present? %> VA</label>
                      </div>
                      <div class="checkbox">
                        <label><%= check_box_tag 'usda', 'usda', params[:usda].present? %> USDA</label>
                      </div>
                      <div class="checkbox">
                        <label><%= check_box_tag 'streamline', 'streamline', params[:streamline].present? %> Streamline</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-2">
              <div class="form-group">
                <div class="checkbox">
                  <label><%= check_box_tag 'full_doc', 'full_doc', params[:full_doc].present? %> Full Doc</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="main-form panel">
        <div class="panel-heading">User Inputs</div>
        <div class="panel-body">
          <div class="row">
            <div class="col-md-2">
              <div class="form-group">
                <label>Credit Score</label>
                <div class="input-group">
                  <%= select_tag 'credit_score', options_for_select(Program::CREDIT_SCORE_LIST, (params[:credit_score] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>LTV</label>
                <div class="input-group">
                  <%= select_tag 'ltv', options_for_select(Program::LTV_VALUES, (params[:ltv] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>CLTV</label>
                <div class="input-group">
                  <%= select_tag 'cltv', options_for_select(Program::CLTV_VALUES, (params[:cltv] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>State</label>
                <div class="input-group">
                  <%= select_tag 'state', options_for_select(Program::STATE, (params[:state] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>Loan Amount</label>
                <% @loan_amount_list =%>
                <%= select_tag 'loan_amount', options_for_select(Program::LOAN_AMOUNT, (params[:loan_amount] rescue nil)), { :class=> "form-control", :required => true} %>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>Program Category</label>
                <%= select_tag 'program_category', options_for_select(Program::PROGRAM_CATEGORY_LIST, (params[:program_category] rescue nil)), { :class=> "form-control", :required => true} %>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>Property Type</label>
                <div class="input-group">
                  <%= select_tag 'property_type', options_for_select(Program::PROPERTY_TYPE_VALUES, (params[:property_type] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>Financing Type</label>
                <div class="input-group">
                  <%= select_tag 'financing_type', options_for_select(Program::FINANCING_TYPE_VALUES, (params[:financing_type] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>Refinance Option</label>
                <div class="input-group">
                  <%= select_tag 'refinance_option', options_for_select(Program::REFINANCE_OPTION_VALUES, (params[:refinance_option] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>Misc Adjuster</label>
                <div class="input-group">
                  <%= select_tag 'misc_adjuster', options_for_select(Program::MISC_ADJUSTER_VALUES, (params[:misc_adjuster] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>Payment Type</label>
                <div class="input-group">
                  <%= select_tag 'payment_type', options_for_select(Program::PATMENT_TYPE_VALUES, (params[:payment_type] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>DTI</label>
                <div class="input-group">
                  <%= select_tag 'dti', options_for_select(Program::DTI_VALUES, (params[:dti] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>Coverage</label>
                <div class="input-group">
                  <%= select_tag 'coverage', options_for_select(Program::COVERAGE_VALUES, (params[:coverage] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label>Margin</label>
                <div class="input-group">
                  <%= select_tag 'margin', options_for_select(Program::MARGIN_VALUES, (params[:margin] rescue nil)), :class=> "form-control" %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-8"></div>
        <div class="col-md-4">
          <div class="form-group">
            <div>
              <label></label>
            </div>
            <%= submit_tag "Search", :class => "btn btn-info btn-block" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
  <!-- end searching form -->
  <div class="row col-md-12 custyle">
    <table class="table table-striped custab table-bordered">
      <thead>
        <h2>Searched Programs</h2>
        <tr>
          <th>No.</th>
          <th>Bank Name</th>
          <th>Loan Category</th>
          <th>Program Category</th>
          <th>Program Name</th>
          <th>Base Rate</th>
          <th>Adjustments</th>
          <th>Adjustment Names</th>
          <th>Final Rate</th>
        </tr>
      </thead>
      <tbody>
      <% if @result.present? %>
        <% @result.each_with_index do |program, index|%>
          <tr>
            <td><%= index +1 %></td>
            <td><%= program[:bank_name] %></td>
            <td><%= program[:loan_category] %></td>
            <td><%= program[:program_category] %></td>
            <td><%= program[:program_name] %></td>
            <td><%= (program[:base_rate].to_f).round(2) %></td>
            <td><%= program[:adj_points] %></td>
            <td>
              <%
                if program[:adj_primary_key] == "Adjustment Not Present"
                  %>
                    <%= program[:adj_primary_key] %>
                  <%
                else
                  program[:adj_primary_key].each_with_index do |key, index|
                    %>
                      <%= index+1 %>. <%= key %><br/>
                    <%
                  end
                end
              %>
            </td>
            <td><%= (program[:final_rate].sum).round(3) rescue nil %></td>
          </tr>
        <%end%>
      <%else%>
        <tr>
          <td colspan="9">No programs..</td>
        </tr>
      <%end%>
      </tbody>
    </table>
  </div>
  <div class="valid">
    <div class='refi'>Please Select Refinance</div>
    <div class='lp' >*Please select values</div>
    <div>
  <br>
    <hr style="border-top: 3px double #8c8b8b;">
  <br>

</div>

<script type="text/javascript">
  $(document).ready(function(){
    $('#bank_name').change(function(){
      var bank_name =  $(this).val();
      var loan_category = "All"
      var pro_category = "All"

      $.ajax({
        type:'GET',
        url:'/dashboard/fetch_programs_by_bank',
        data: {bank_name : bank_name, loan_category: loan_category, pro_category: pro_category },
        success:function(response){
          var selectBox = document.getElementById('program_name');
          selectBox.options.length = 0
          selectBox.options.add( new Option('All', 'All'));
          response.program_list.map((program)=>{
            selectBox.options.add( new Option(program.name, program.name));
          });
          var selectBox2 = document.getElementById('loan_category');
          selectBox2.options.length = 0
          selectBox2.options.add( new Option('All', 'All'));
          response.loan_category_list.map((loan_category)=>{
            selectBox2.options.add( new Option(loan_category.name, loan_category.name));
          });
          var selectBox3 = document.getElementById('pro_category');
          selectBox3.options.length = 0
          response.pro_category_list.map((pro_category)=>{
            selectBox3.options.add( new Option(pro_category.name, pro_category.name));
          });

        }
      });
    });

    $('#loan_category').change(function(){
      var loan_category =  $(this).val();
      var bank_name = $('#bank_name').val()
      var pro_category ="All"
      $.ajax({
        type:'GET',
        url:'/dashboard/fetch_programs_by_bank',
        data: {loan_category : loan_category, bank_name : bank_name, pro_category: pro_category },
        success:function(response){
          var selectBox = document.getElementById('program_name');
          selectBox.options.length = 0
          selectBox.options.add( new Option('All', 'All'));
          response.program_list.map((program)=>{
            selectBox.options.add( new Option(program.name, program.name));
          });

          var selectBox2 = document.getElementById('pro_category');
          selectBox2.options.length = 0
          response.pro_category_list.map((pro_category)=>{
            selectBox2.options.add( new Option(pro_category.name, pro_category.name));
          });
        }
      });
    });

    $('#pro_category').change(function(){
      var pro_category =  $(this).val();
      var bank_name = $('#bank_name').val()
      var loan_category = $('#loan_category').val()
      $.ajax({
        type:'GET',
        url:'/dashboard/fetch_programs_by_bank',
        data: {loan_category : loan_category, bank_name : bank_name, pro_category: pro_category },
        success:function(response){
          var selectBox = document.getElementById('program_name');
          selectBox.options.length = 0
          selectBox.options.add( new Option('All', 'All'));
          response.program_list.map((program)=>{
            selectBox.options.add( new Option(program.name, program.name));
          });
        }
      });
    });


    $(".alert-error" ).fadeOut(3000);
     if ($("#loan_type").val() == "ARM") {
      $(".arm-basic").show()
      $(".term").hide()
    }else{
     $(".arm-basic").hide()
     $(".term").show()
    }

   $("#loan_type").on('click', function(e){
     if ($(this).val()=="ARM"){
      $(".term").hide()
      $(".arm-basic").show()
     }else{
        $(".arm-basic").hide()
        $(".term").show()
     }
   });
  });

  $('#du').click(function(){
    if($(this).prop("checked") == true){
      $('#fannie_mae').attr('checked', true);
    }
    else{
      $('#fannie_mae').attr('checked', false);
    }
  });

   $('#lp').click(function(){
    if($(this).prop("checked") == true){
      $('#freddie_mac').attr('checked', true);
    }
    else{
      $('#freddie_mac').attr('checked', false);
    }
  });


  $('#streamline').click(function () {
    if ($(this).prop("checked")) {
      $("#loan_purpose").val('Refinance')
      $('#fha').attr('checked', true);
    } else {
      $("#loan_purpose").val('')
      $('#fha').attr('checked', false);
    }
  });

  // Validation
  $('form').submit(function () {
    // !$("#loan_purpose").val('Purchase')
    var loan_purpose = $.trim($('#loan_purpose').val());
    var loan_size = $.trim($('#loan_size').val());
    var loan_type = $.trim($('#loan_type').val());
    var term = $.trim($('#term').val());
    streamline = $('#streamline').prop("checked")
    // Check if empty loan_purpose
    // if (loan_purpose  === '') {
    //   $("#loan_purpose").css('border-color', 'red')
    //   $("#loan_purpose").after($('.lp'));
    //    // $("#loan_purpose").after("<b>Please select Loan Purpose</b>");
    //   return false;
    // }
    // if (loan_size  === '') {
    //   $("#loan_size").css('border-color', 'red')
    //   $("#loan_size").after($('.lp'));
    //    // $("#loan_purpose").after("<b>Please select Loan Purpose</b>");
    //   return false;
    // }
    // if (loan_type  === '') {
    //   $("#loan_type").css('border-color', 'red')
    //   $("#loan_type").after($('.lp'));
    //    // $("#loan_purpose").after("<b>Please select Loan Purpose</b>");
    //   return false;
    // }
    // if (term  === '') {
    //   $("#term").css('border-color', 'red')
    //   $("#term").after($('.lp'));
    //    // $("#loan_purpose").after("<b>Please select Loan Purpose</b>");
    //   return false;
    // }
    if (loan_purpose != "Refinance" && streamline) {
      $("#loan_purpose").css('border-color', 'red')
      $("#loan_purpose").after($('.refi'));
      // $("#loan_purpose").after("<b>Please select Refinance</b>");
      return false;
    }
  });

  $('#fannie_mae_product').change(function(){
    var fannie_mae_product =  $(this).val();
    if (fannie_mae_product == "HomeReady") {
      $('#fannie_mae').attr('checked', true)
    }
  })

  $('#freddie_mac_product').change(function(){
    var freddie_mac_product =  $(this).val();
    if (freddie_mac_product == "Home Possible") {
      $('#freddie_mac').attr('checked', true)
    }
  })


</script>